import{_ as e,r as o,o as c,c as i,a as l,b as n,d as s,f as p,e as a}from"./app-iph3vjA0.js";const u={},k=a(`<p><a name="xYBck"></a></p><h3 id="_01-ç™»å½•æ—¶åº" tabindex="-1"><a class="header-anchor" href="#_01-ç™»å½•æ—¶åº" aria-hidden="true">#</a> <strong>01/ ç™»å½•æ—¶åº</strong></h3><p><strong>å¾®ä¿¡ç™»å½•æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º:</strong><br>æ­¥éª¤ï¼š</p><ol><li><pre><code> å°ç¨‹åºè°ƒç”¨wx.login()è·å–ä¸´æ—¶ç™»å½•å‡­è¯codeã€‚
</code></pre></li><li><pre><code> å°ç¨‹åºå°†codeä¼ åˆ°å¼€å‘è€…æœåŠ¡å™¨ã€‚
</code></pre></li><li><pre><code> å¼€å‘è€…æœåŠ¡å™¨ä»¥**codeæ¢å–ç”¨æˆ·å”¯ä¸€æ ‡è¯†openidå’Œä¼šè¯å¯†é’¥****session_key**ã€‚
</code></pre></li><li><pre><code> å¼€å‘è€…æœåŠ¡å™¨å¯**ç»‘å®šå¾®ä¿¡ç”¨æˆ·èº«ä»½id**å’Œ**ä¸šåŠ¡ç”¨æˆ·èº«ä»½**ã€‚
</code></pre></li><li><pre><code> å¼€å‘è€…æœåŠ¡å™¨å¯ä»¥æ ¹æ®ç”¨æˆ·æ ‡è¯†æ¥**ç”Ÿæˆè‡ªå®šä¹‰ç™»å½•æ€**ï¼Œ**ç”¨äº**åç»­ä¸šåŠ¡é€»è¾‘ä¸­å‰åç«¯äº¤äº’æ—¶**è¯†åˆ«ç”¨æˆ·èº«ä»½**ã€‚
</code></pre></li></ol><p><img src="https://raw.githubusercontent.com/tengyuanOasis/image/master/1616747882862-68167fd2-c89c-418b-b378-1eec3450e443.png" alt="image.png"></p><h3 id="_02-åè¯è§£é‡Š" tabindex="-1"><a class="header-anchor" href="#_02-åè¯è§£é‡Š" aria-hidden="true">#</a> <strong>02/ åè¯è§£é‡Š</strong></h3><p>ä¸Šé¢çš„ç™»å½•æ—¶åºä¸­ï¼Œæˆ‘ä»¬ä¼šæ¶‰åŠåˆ°ä¸€äº›æ•°æ®å’Œå‚æ•°ï¼Œå…ˆæ¥äº†è§£ä¸‹å®ƒä»¬éƒ½æ˜¯ç”¨æ¥åšå•¥çš„ã€‚</p>`,7),r=a("<li><strong>code</strong>(ä¸´æ—¶ç™»å½•å‡­è¯ ) åœ¨å°ç¨‹åºä¸­è°ƒç”¨<code>wx.login()</code>ï¼Œèƒ½æ‹¿åˆ°ä¸€ä¸ª<code>code</code>ä½œä¸ºç”¨æˆ·ç™»å½•å‡­è¯ï¼ˆæœ‰æ•ˆæœŸäº”åˆ†é’Ÿï¼‰ã€‚ <ol><li>åœ¨å¼€å‘è€…æœåŠ¡å™¨åå°ï¼Œå¼€å‘è€…å¯ä½¿ç”¨<code>code</code>æ¢å–<code>openid</code>å’Œ<code>session_key</code>ç­‰ä¿¡æ¯ï¼ˆ<code>code</code>åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼‰ã€‚</li><li>code çš„è®¾è®¡ï¼Œ<strong>ä¸»è¦ç”¨äºé˜²æ­¢é»‘å®¢ä½¿ç”¨ç©·ä¸¾ç­‰æ–¹å¼æŠŠä¸šåŠ¡ä¾§ä¸ªäººä¿¡æ¯æ•°æ®å…¨æ‹‰èµ°ã€‚</strong></li></ol></li><li><strong>AppId <strong>ä¸ <strong>AppSecret</strong>ä¸ºäº†ç¡®ä¿æ‹¿</strong>code è¿‡æ¥æ¢å–èº«ä»½ä¿¡æ¯çš„äººå°±æ˜¯å¯¹åº”çš„å°ç¨‹åºå¼€å‘è€…</strong>ï¼Œåˆ°å¾®ä¿¡æœåŠ¡å™¨çš„è¯·æ±‚è¦åŒæ—¶å¸¦ä¸Š AppId å’Œ AppSecretã€‚</li>",2),d=n("strong",null,[s("session_key "),n("strong",null,[s("ä¼šè¯å¯†é’¥"),n("code",null,"session_key"),s("æ˜¯å¯¹")]),s("ç”¨æˆ·æ•°æ®è¿›è¡ŒåŠ å¯†ç­¾åçš„å¯†é’¥")],-1),v={href:"https://cloud.tencent.com/solution/data_protection?from=10680",target:"_blank",rel:"noopener noreferrer"},m=n("li",null,[s("è®¾è®¡ session_key ä¸»è¦æ˜¯ä¸ºäº†èŠ‚çœæµç¨‹æ¶ˆè€—ï¼Œå¦‚æœæ¯æ¬¡éƒ½é€šè¿‡å°ç¨‹åºå‰ç«¯"),n("code",null,"wx.login()"),s("ç”Ÿæˆå¾®ä¿¡ç™»å½•å‡­è¯"),n("code",null,"code"),s("å»å¾®ä¿¡æœåŠ¡å™¨è¯·æ±‚ä¿¡æ¯ï¼Œæ­¥éª¤å¤ªå¤šä¼šé€ æˆæ•´ä½“è€—æ—¶æ¯”è¾ƒä¸¥é‡ã€‚")],-1),b=a('<li>**wx.checkSession()**å¯ä»¥æ ¡éªŒ<code>session_key</code>æ˜¯å¦æœ‰æ•ˆã€‚ç”¨æˆ·è¶Šé¢‘ç¹ä½¿ç”¨å°ç¨‹åºï¼Œ<code>session_key</code>æœ‰æ•ˆæœŸè¶Šé•¿,<code>session_key</code>å¤±æ•ˆæ—¶ï¼Œå¯ä»¥é€šè¿‡é‡æ–°æ‰§è¡Œç™»å½•æµç¨‹è·å–æœ‰æ•ˆçš„<code>session_key</code>ã€‚</li><li><strong>openid æ˜¯å¾®ä¿¡ç”¨æˆ· id</strong>ï¼Œå¯ä»¥ç”¨è¿™ä¸ª<code>id</code>æ¥åŒºåˆ†ä¸åŒçš„å¾®ä¿¡ç”¨æˆ·ã€‚ å¾®ä¿¡é’ˆå¯¹ä¸åŒçš„ç”¨æˆ·åœ¨ä¸åŒçš„åº”ç”¨ä¸‹éƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ª<code>openid</code>, ä½†æ˜¯è¦æƒ³ç¡®å®šç”¨æˆ·æ˜¯ä¸æ˜¯åŒä¸€ä¸ªç”¨æˆ·ï¼Œå°±éœ€è¦é <code>unionid</code>æ¥åŒºåˆ†ã€‚</li><li>**unionid **å¦‚æœå¼€å‘è€…æ‹¥æœ‰å¤šä¸ªç§»åŠ¨åº”ç”¨ã€ç½‘ç«™åº”ç”¨ã€å’Œå…¬ä¼—å¸å·ï¼ˆåŒ…æ‹¬å°ç¨‹åºï¼‰ï¼Œå¯é€šè¿‡<code>unionid</code>æ¥åŒºåˆ†ç”¨æˆ·çš„å”¯ä¸€æ€§ã€‚åŒä¸€ç”¨æˆ·ï¼Œå¯¹åŒä¸€ä¸ªå¾®ä¿¡å¼€æ”¾å¹³å°ä¸‹çš„ä¸åŒåº”ç”¨ï¼Œ<code>unionid</code>æ˜¯ç›¸åŒçš„ã€‚ <a name="XNlnt"></a></li>',3),g=a('<h3 id="_03-éœ€æ±‚åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_03-éœ€æ±‚åˆ†æ" aria-hidden="true">#</a> 03/ éœ€æ±‚åˆ†æ</h3><p><a name="ChatN"></a></p><h4 id="_1-æˆæƒç™»å½•" tabindex="-1"><a class="header-anchor" href="#_1-æˆæƒç™»å½•" aria-hidden="true">#</a> 1. æˆæƒç™»å½•:</h4>',3),h=n("li",null,[s("å…¶å®å¾®ä¿¡ç™»å½•å¹¶ä¸éœ€è¦æˆæƒ,ä»…ä»…éœ€è¦é€šè¿‡"),n("code",null,"wx.login()"),s("è·å–ä¸´æ—¶ç™»å½•å‡­è¯ç»™åå°,å°±èƒ½æ‹¿åˆ°ç”¨æˆ·çš„"),n("code",null,"openId"),s("å’Œ "),n("code",null,"session_key"),s("ã€‚")],-1),f=n("code",null,"wx.getUserInfo",-1),_=n("code",null,"wx.getPhoneNumber",-1),y=n("code",null,"wx.getUserInfo()",-1),S={href:"https://developers.weixin.qq.com/community/develop/doc/0000a26e1aca6012e896a517556c01",target:"_blank",rel:"noopener noreferrer"},w=n("li",null,[s("è¿™é‡ŒæŒ‰ç…§å¾®ä¿¡å®˜æ–¹ç»™çš„æ–‡æ¡£æ“ä½œå³å¯,ä¸åšè¿‡å¤šè¯´æ˜ "),n("a",{name:"Nr2FP"})],-1),I=a(`<h4 id="_2-ç™»å½•åŠ é”" tabindex="-1"><a class="header-anchor" href="#_2-ç™»å½•åŠ é”" aria-hidden="true">#</a> 2. ç™»å½•åŠ é”:</h4><p>åœ¨å®é™…ä¸­æˆ‘ä»¬å¼€å‘è¿‡ç¨‹ä¸­ä¼šæœ‰å¤šä¸ªåœ°æ–¹è§¦å‘ç™»å½•é€»è¾‘,è¿™é‡Œéœ€è¦åšä¸€ä¸‹åŠ é”æ–¹å¼é‡å¤ç™»å½•</p><p>ä½¿ç”¨<code>IS_LOGIN_ING</code>æ¥åˆ¤æ–­æ˜¯å¦æ­£åœ¨ç™»å½•,demo å¦‚ä¸‹:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> Taro <span class="token keyword">from</span> <span class="token string">&#39;@tarojs/taro&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> loginApi <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/api&#39;</span><span class="token punctuation">;</span> <span class="token comment">// ç™»å½•æ¥å£</span>

<span class="token keyword">let</span> <span class="token constant">IS_LOGIN_ING</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//ç”¨æ¥é™åˆ¶ä¸€ä¸‹ç™»å½•é€»è¾‘</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">//åˆ¤æ–­æ˜¯å¦æ­£åœ¨ç™»å½•,æ­£åœ¨ç™»å½•çš„è¯åˆ™è¯·æ±‚å»¶å</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">IS_LOGIN_ING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token function">reLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						<span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						<span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token constant">IS_LOGIN_ING</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			Taro<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				<span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token function">loginApi</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">code</span><span class="token operator">:</span> res<span class="token punctuation">.</span>code <span class="token punctuation">}</span><span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
							<span class="token comment">//ç™»é™†æˆåŠŸ,å­˜ä¸€ä¸‹tokenç­‰</span>
							<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
							<span class="token comment">// ç™»å½•å¤±è´¥ï¼Œè§£é™¤é”ï¼Œé˜²æ­¢æ­»é”</span>
							<span class="token constant">IS_LOGIN_ING</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
							<span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token comment">// ç™»å½•å¤±è´¥ï¼Œè§£é™¤é”ï¼Œé˜²æ­¢æ­»é”</span>
					<span class="token constant">IS_LOGIN_ING</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
					<span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a name="8RYKZ"></a></p><h4 id="_3-session-key-è¿‡æœŸé‡æ–°é™é»˜ç™»å½•" tabindex="-1"><a class="header-anchor" href="#_3-session-key-è¿‡æœŸé‡æ–°é™é»˜ç™»å½•" aria-hidden="true">#</a> 3.session_key è¿‡æœŸé‡æ–°é™é»˜ç™»å½•:</h4><p>å¾®ä¿¡çš„<strong>session_key æ˜¯æœ‰æ—¶æ•ˆæ€§çš„</strong>,æˆ‘ä»¬å¯ä»¥ä¿è¯åç«¯è‡ªå·±ç”Ÿæˆçš„ token ä¸ä¼šè¿‡æœŸ,ä½†æ˜¯ session_key éœ€è¦æ‰‹åŠ¨æ£€æµ‹,è¿™é‡Œå¾®ä¿¡å®˜æ–¹æä¾›äº†ä¸€ä¸ª api , <code>wx.checkSession()</code> ,è¿™é‡Œæœ‰ä¸¤ä¸ªä¸œè¥¿:</p><ol><li>å¾®ä¿¡ç»™åˆ°çš„ session_key , æ—¶æ•ˆä¸ç¡®å®š , <strong>å®‰å…¨èµ·è§,åç«¯ä¿å­˜,ä¸è¿”ç»™å‰ç«¯</strong></li><li>æˆ‘ä»¬åç«¯æ ¹æ® session_key ç”Ÿæˆçš„ token , <strong>æ—¶æ•ˆå®‰å…¨éƒ½åœ¨å¯æ§èŒƒå›´å†…</strong></li></ol><p><strong>But~å•¥æ—¶å€™ç”¨å‘¢?</strong><br>**æˆ‘ä¹‹å‰çš„é€»è¾‘: **æ—¢ç„¶ä»–å¯ä»¥æ£€æµ‹åˆ°æˆ‘ session_key æœ‰æ²¡æœ‰è¿‡æœŸ,é‚£æˆ‘æ¯ä¸ªé¡µé¢<code>onShow</code>Â  çš„æ—¶å€™è°ƒç”¨è¿™ä¸ª api,è¿‡æœŸäº†æˆ‘é‡æ–°ç™»å½•ä¸å°±è¡Œäº†~~~~æ”¹å®Œæµ‹è¯•å‘å®¡æ ¸, è¿‡äº†ä¸€å¤© , æµ‹è¯•å¤§äººåé¦ˆ , ç™»å½•è¿˜æ˜¯æœ‰é—®é¢˜ ,å†æƒ³ä¸€ä¸‹,è¿™æ ·å­å†™ä¼šæœ‰è¿™ä¹ˆå‡ ä¸ªé—®é¢˜(ä¸‹é¢ä¸¾ä¸ª ğŸŒ°, é¦–é¡µçš„ api å‡éœ€è¦æºå¸¦ token æ‰èƒ½æ­£å¸¸å‘é€è¯·æ±‚)</p><ol><li>å‡å¦‚æˆ‘è¿›é¦–é¡µçš„æ—¶å€™,session_key æœªè¿‡æœŸ, <code>checkSession()</code>é€šè¿‡ , ä½†æ˜¯æˆ‘åˆšè¿›æ¥,ä»–å°±è¿‡æœŸäº† , wtf ?è¿™è¿æ°”,èƒ½è¯´ç‚¹å•¥.... ç„¶åæˆ‘è¿™æ—¶å€™å†å»å‘è¯·æ±‚ , ok ,åç«¯æç¤ºç™»å½•æ€å¤±æ•ˆäº† ğŸ˜—ğŸ˜…ğŸ˜¥ğŸ¤¤ğŸ˜‡</li><li>å‡å¦‚æˆ‘å¾ˆå¤šé¡µé¢éƒ½è¦ç”¨åˆ° token,æ˜¯ä¸æ˜¯æ¯ä¸ªé¡µé¢éƒ½å¾—<code>onShow</code>çš„æ—¶å€™éƒ½å†™ä¸€é checkSession è¿™ä¸ªé€»è¾‘å˜,è¿™ä¹Ÿå¤ªéº»çƒ¦äº†</li><li>â€¦â€¦</li><li>è‚¯å®šè¿˜æœ‰å…¶ä»–é—®é¢˜æˆ‘æ²¡æƒ³åˆ°,åæ­£è¿™ä¸ªæƒ³æ³•ä¹Ÿå¤ªç®€å•éšä¾¿äº†~</li></ol><p><strong>æ¥ä¸‹æ¥æ˜¯æ­£è§£:ğŸ‘µğŸ‘µğŸ‘µ</strong><br><strong>1.æœ¬ç€ä¸ºäº†å·æ‡’è€Œå·æ‡’çš„åŸåˆ™, æˆ‘é€‰æ‹©å‘è¯·æ±‚çš„æ—¶å€™ check ä¸€ä¸‹, ä½†æ˜¯è¯·æ±‚ä¹‹å‰ï¼ŒcheckSession ä¹Ÿå¾—åšä¸€ä¸‹å°è£…ï¼Œç™»å½•å¤±æ•ˆäº†é‡æ–°ç™»å½•</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> Taro <span class="token keyword">from</span> <span class="token string">&#39;@tarojs/taro&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> loginApi <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/api&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> reLogin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./reLogin&#39;</span><span class="token punctuation">;</span> <span class="token comment">//è¿™ä¸ªæ˜¯å‰é¢çš„login</span>

<span class="token comment">//åŠ é”</span>
<span class="token keyword">let</span> <span class="token constant">IS_SESSION_CHECKING</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//æ˜¯å¦åœ¨æ­£åœ¨æŸ¥çœ‹session_key</span>
<span class="token keyword">let</span> <span class="token constant">IS_SESSION_REFRESH</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//session_keyæ˜¯å¦åˆ·æ–°</span>

<span class="token comment">//è¿™é‡Œç»™å‡ ä¸ªçŠ¶æ€,æ–¹ä¾¿è°ƒè¯•çš„æ—¶å€™åŒºåˆ†</span>
<span class="token keyword">const</span> checkSessionResult <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token constant">VAILD</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//æœªè¿‡æœŸ</span>
	<span class="token constant">RELOGIN</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//è¿‡æœŸå¹¶é‡æ–°ç™»é™†</span>
	<span class="token constant">UNAUTH</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">//é¦–æ¬¡ç™»å½•ä½¿ç”¨å°ç¨‹åº</span>
	<span class="token constant">FAILED</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">checkSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">//æŸ¥çœ‹å†…å­˜ä¸­æ˜¯å¦æœ‰token</span>
		<span class="token keyword">const</span> token <span class="token operator">=</span> Taro<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">IS_SESSION_CHECKING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//æ­£åœ¨æ£€æŸ¥session,è¯·æ±‚å»¶å</span>
			<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token function">checkSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						<span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						<span class="token function">reject</span><span class="token punctuation">(</span>checkSessionResult<span class="token punctuation">.</span><span class="token constant">FAILED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">IS_SESSION_REFRESH</span> <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token constant">IS_SESSION_CHECKING</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			Taro<span class="token punctuation">.</span><span class="token function">checkSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				<span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token comment">// session_key æœªè¿‡æœŸï¼Œå¹¶ä¸”åœ¨æœ¬ç”Ÿå‘½å‘¨æœŸä¸€ç›´æœ‰æ•ˆ</span>
					<span class="token constant">IS_SESSION_REFRESH</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
					<span class="token function">resolve</span><span class="token punctuation">(</span>checkSessionResult<span class="token punctuation">.</span><span class="token constant">VAILD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token comment">// session_key å·²ç»å¤±æ•ˆï¼Œéœ€è¦é‡æ–°æ‰§è¡Œç™»å½•æµç¨‹</span>
					Taro<span class="token punctuation">.</span><span class="token function">removeStorage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
						<span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&#39;token&#39;</span><span class="token punctuation">,</span>
						<span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
							<span class="token function">reLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//é™é»˜ç™»å½•</span>
								<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
									<span class="token function">resolve</span><span class="token punctuation">(</span>checkSessionResult<span class="token punctuation">.</span><span class="token constant">RELOGIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token punctuation">}</span><span class="token punctuation">)</span>
								<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
									<span class="token function">reject</span><span class="token punctuation">(</span>checkSessionResult<span class="token punctuation">.</span><span class="token constant">FAILED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token constant">IS_SESSION_CHECKING</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">reLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token function">reject</span><span class="token punctuation">(</span>checkSessionResult<span class="token punctuation">.</span><span class="token constant">FAILED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">resolve</span><span class="token punctuation">(</span>checkSessionResult<span class="token punctuation">.</span><span class="token constant">UNAUTH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2 . ä¸€èˆ¬å¤§å®¶éƒ½åœ¨å°ç¨‹åºå¯åŠ¨çš„æ”¶ check ä¸€ä¸‹ session,è¿‡æœŸäº†é¡ºä¾¿è‡ªåŠ¨ç™»å½•ä¸€ä¸‹,é¦–æ¬¡ç™»å½•ç™»å½•å³å¯</strong><a name="NFwrN"></a></p><h4 id="" tabindex="-1"><a class="header-anchor" href="#" aria-hidden="true">#</a> <img src="https://cdn.nlark.com/yuque/0/2021/png/1451656/1616751995187-8b8179f7-f5c3-4299-8133-159361ffcce6.png#align=left&amp;display=inline&amp;height=378&amp;margin=[object Object]&amp;name=image.png&amp;originHeight=378&amp;originWidth=732&amp;size=32305&amp;status=done&amp;style=none&amp;width=732" alt="image.png"></h4><p><a name="Fbez1"></a></p><h4 id="_4-request-æ”¹é€ " tabindex="-1"><a class="header-anchor" href="#_4-request-æ”¹é€ " aria-hidden="true">#</a> 4.request æ”¹é€ </h4><p>å‰é¢å·²ç»æå¥½äº† checkSession å’Œ relogin å‡½æ•°ï¼Œè¯·æ±‚ä¹Ÿéœ€è¦åšä¸€ä¸‹ç›¸åº”çš„ä¿®æ”¹ï¼Œè¿™æ ·å­æ¯æ¬¡è¯·æ±‚å‰éƒ½ check ä¸€ä¸‹ session æœ‰æ²¡æœ‰è¿‡æœŸï¼Œè¿‡æœŸäº†å…ˆç™»å½•ç„¶åå†å»å‘è¯·æ±‚</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> Taro<span class="token punctuation">,</span> <span class="token punctuation">{</span> request <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@tarojs/taro&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> checkSession <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./checkSession&#39;</span><span class="token punctuation">;</span>

<span class="token comment">//è¯·æ±‚å‡½æ•°</span>
<span class="token keyword">function</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//send requst</span>
<span class="token punctuation">}</span>

<span class="token comment">//è¿™é‡Œå¯¹è¯·æ±‚å‡½æ•°åšä¸€å±‚äºŒæ¬¡å°è£…</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> method <span class="token operator">=</span> <span class="token string">&#39;GET&#39;</span><span class="token punctuation">,</span> params <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&#39;application/json&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token function">checkSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token comment">// console.log(&#39;res: &#39;, res);</span>
				<span class="token comment">//  0, æœªè¿‡æœŸ</span>
				<span class="token comment">// 	1, è¿‡æœŸå¹¶é‡æ–°ç™»é™†</span>
				<span class="token comment">// 	2, é¦–æ¬¡ç™»å½•ä½¿ç”¨å°ç¨‹åº</span>
				<span class="token comment">// -1, å¤±è´¥</span>
				<span class="token function">sendRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> method<span class="token punctuation">,</span> params <span class="token punctuation">}</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a name="FC9Y4"></a></p><h3 id="_04-æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#_04-æ€»ç»“" aria-hidden="true">#</a> 04/æ€»ç»“:</h3><p>å†ä¹Ÿä¸çˆ±å°ç¨‹åºäº†,ç»™æˆ‘æ•´åäº†éƒ½ ğŸ˜µğŸ˜µğŸ˜µğŸ˜µğŸ˜µğŸ˜µğŸ˜µğŸ˜µğŸ˜µ</p>`,21);function N(x,j){const t=o("ExternalLinkIcon");return c(),i("div",null,[l(" @format "),k,n("ol",null,[r,n("li",null,[d,s("ã€‚ "),n("ol",null,[n("li",null,[s("ä¸ºäº†åº”ç”¨è‡ªèº«çš„"),n("a",v,[s("æ•°æ®å®‰å…¨"),p(t)]),s("ï¼Œå¼€å‘è€…æœåŠ¡å™¨ä¸åº”è¯¥æŠŠä¼šè¯å¯†é’¥ä¸‹å‘åˆ°å°ç¨‹åºï¼Œä¹Ÿä¸åº”è¯¥å¯¹å¤–æä¾›è¿™ä¸ªå¯†é’¥ã€‚")]),m])]),b]),g,n("ul",null,[h,n("li",null,[s("æˆæƒç™»å½•æ˜¯æŒ‡ç™»å½•å‰åšçš„ä¸€äº›é¢å¤–æ“ä½œï¼Œæ¯”å¦‚"),f,s("ã€"),_,s("ç­‰,ä¼šå¼¹å‡ºæˆæƒæ¡†ç»™ç»™ç”¨æˆ·æˆæƒä¹‹å,å†åšç™»å½•æ“ä½œ(æœ‰ä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯å¾®ä¿¡æœ€è¿‘æœ‰åšä¸€ä¸ªè¾ƒå¤§çš„æ”¹åŠ¨ä½¿ç”¨ "),y,s(" æ¥å£ç›´æ¥å¼¹å‡ºæˆæƒæ¡†çš„å¼€å‘æ–¹å¼å°†é€æ­¥ä¸å†æ”¯æŒ,è¯¦è§"),n("a",S,[s("å°ç¨‹åºä¸å°æ¸¸æˆè·å–ç”¨æˆ·ä¿¡æ¯æ¥å£è°ƒæ•´"),p(t)]),s(")")]),w]),I])}const L=e(u,[["render",N],["__file","weixinshouquandenglujijingmodengluchuli.html.vue"]]);export{L as default};
